<?xml version="1.0" encoding="UTF-8"?>

<project name="AntBuild" default="test">

	<property name="webstart.dir" location="webstart" />
	<property name="build.dir" location="bin" />
	<property name="clover.jar" location="antlips/lib/clover.jar" />

	<path id="classpath">
		<pathelement path="sneerAPI-bin"/>
		<pathelement path="${build.dir}"/>
		<pathelement path="bricks/lib/bcprov-jdk16-139.jar"/>
		<pathelement path="kernel/lib/asm-all-3.1.jar"/>
	</path>

	<target name="test" depends="test-execution, test-verification">
	</target>
	
	<target name="test-verification" if="junit.failures">
		<!--fail>Test failures! Check the output for details.</fail-->
		<echo>Test failures! Check the output for details.</echo>
	</target>
		
	<target name="test-execution" depends="compile">
		<junit printsummary="true" failureproperty="junit.failures" fork="yes">
			<sysproperty key="java.awt.headless" value="${java.awt.headless}" />
			<classpath>
				<path refid="classpath" />
				<pathelement location="${clover.jar}" />
			</classpath>
			<batchtest todir="sneerAPI-bin">
				<fileset dir="sneerAPI-bin">
					<include name="**/tests/*Test.class" />
				</fileset>
				<formatter type="plain"/>
			</batchtest>
			<batchtest todir="${build.dir}">
				<fileset dir="${build.dir}">
					<include name="**/tests/*Test.class" />
				</fileset>
				<formatter type="plain"/>
			</batchtest>
		</junit>
	</target>

	<target name="compile" depends="copy-resources">

		<javac srcdir="wheel/src"
				destdir="sneerAPI-bin"
				listfiles="true"
				failonerror="true"
				debug="on"
				target="1.5"
				encoding="utf-8">
			<classpath refid="classpath"/>
		</javac>

		<javac srcdir="spikes/src"
				destdir="${build.dir}"
				listfiles="true"
				failonerror="true"
				debug="on"
				target="1.5"
				encoding="utf-8">
			<classpath refid="classpath"/>
		</javac>

	</target>

	<target name="copy-resources" depends="init">

		<copy todir="sneerAPI-bin">
			<fileset dir="wheel/src">
				<include name='**/**'/>
				<exclude name='**/*.java'/>
			</fileset>
		</copy>

		<copy todir="${build.dir}">
			<fileset dir="spikes/src">
				<include name='**/**'/>
				<exclude name='**/*.java'/>
			</fileset>
		</copy>

	</target>
	
	<target name="init">
		<mkdir dir="sneerAPI-bin"/>
		<mkdir dir="${build.dir}"/>
	</target>

	<target name="clean">
		<delete dir="sneerAPI-bin"/>
		<delete dir="${build.dir}"/>
	</target>

	<!-- clover support -->
	<target name="init-clover">
		<taskdef resource="cloverlib.xml" classpath="${clover.jar}"/>
		<clover-setup initString="mycoverage.db"/>
	</target>
	
	<target name="clover-report" depends="clean, init-clover, test-execution">
		<fileset dir="." id="clover.sources">
			<include name="wheel/src/**/*.java" />
			<include name="spikes/src/**/*.java" />
		</fileset>
		
		<clover-report>
	       <current outfile="clover.xml">
	          <format type="xml"/>
	       	  <fileset refid="clover.sources" />
	       </current>
	    </clover-report>
		
		<clover-report>
	       <current outfile="clover">
	          <format type="html"/>
	       	  <fileset refid="clover.sources" />
	       </current>
	    </clover-report>
	</target>

	<target name="makeJavaWebStart" depends="makeJars, makeJnlp">
	</target>

	<target name="makeJars">
		<delete dir="${webstart.dir}/build"/>
		<mkdir dir="${webstart.dir}/build"/>

		<jar destfile="${webstart.dir}/build/sneer.jar">
		    <fileset dir="bin-kernel">
		    	<exclude name='**/*.txt'/>
		    	<exclude name='**/tests/**'/>
		    </fileset>
		    <fileset dir="${build.dir}/build">
		    	<exclude name='**/*.txt'/>
		    	<exclude name='**/tests/**'/>
		    	<exclude name='functional/**'/>
		    	<exclude name='spikes/**'/>
		    	<exclude name='antlips/**'/>
				<exclude name='build/**'/>
		    </fileset>
		</jar>
	</target>

	<target name="signJars" depends="copyJars">
		<signjar keystore="${webstart.dir}/sneerKeystore" jar="${webstart.dir}/build/bcprov-jdk16-139.jar" alias="bihaiko" storepass="amanda"/>
		<signjar keystore="${webstart.dir}/sneerKeystore" jar="${webstart.dir}/build/asm-all-3.1.jar" alias="bihaiko" storepass="amanda"/>
		<signjar keystore="${webstart.dir}/sneerKeystore" jar="${webstart.dir}/build/sneer.jar>" alias="bihaiko" storepass="amanda"/>	
	</target>

	<target name="makeJnlp" depends="signJars">
		<echoxml file="${webstart.dir}/build/sneer.jnlp">
			<jnlp spec="1.0+" codebase="file:///${webstart.dir}/build" href="sneer.jnlp">
				<information>
					<title>Sneer!</title>
					<vendor>Sovereign Computing</vendor>
					<description>Sovereign computing is the freedom to share information and hardware resources with your friends, any way you like.:)</description>
					<description kind="short">Sneer is a java-based, free software platform for sovereign applications.</description>
					<homepage href="http://sovereigncomputing.net/"/>
				</information>
				<update check="timeout" policy="always"/>
				<resources>     
					<jar href="sneer.jar"/>
					<jar href="bcprov-jdk16-139.jar"/>
					<jar href="asm-all-3.1.jar"/>					
					<j2se version="1.6+" href="http://java.sun.com/products/autodl/j2se"/>
				</resources>
				<security>
					<all-permissions/>
				</security>
				<application-desc main-class="main.MainDemo"/>
			</jnlp>
		</echoxml>
	</target>

	<target name="copyJars">
		<copy todir="${webstart.dir}/build" file="bricks/lib/bcprov-jdk16-139.jar"/>
		<copy todir="${webstart.dir}/build" file="kernel/lib/asm-all-3.1.jar"/>					
	</target>

</project>